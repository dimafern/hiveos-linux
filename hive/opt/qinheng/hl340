#!/usr/bin/env bash

[[ -z $1 ]] &&
	echo "Usage: `basename $0` ping|reset [port]" &&
	exit 1

PORT=/dev/china_dog0

[[ ! -z $2 ]] &&
	PORT=$2 ||
	echo "No port given, using default"

echo "Using $PORT"



[[ ! -c $PORT ]] &&
	echo "$PORT is not a character device" &&
	exit 1

ping="echo -ne "r90p90""
reset="echo -ne "r2p90""

if [[ ! -e /hive-config/watchdog/wd-nano.on ]]; then
	ping="echo -ne "\x1E\x00""
	reset="echo -ne "\xFF\x55""
elif [[ ! -e /hive-config/watchdog/wd-fixorgua.on ]]; then
	#https://fix.org.ua/index.php/fix-forum/tekhpodderzhka/67-po-dlya-watchdog?start=6#135
	ping="echo -ne ""\x31""\x41"""
	reset="echo -ne "\x33\x33""
fi


if [[ $1 == "reset" ]]; then
	echo "Pushing Reset"
	$reset > $PORT
	exit 0
fi


#if [[ $1 == "power" ]]; then
#        echo "Pushing Power"
#        echo -n "~T2" > $PORT
#        exit 0
#fi


#should be ping here, but will work with any
#Send 60 second timeout to WD in HEX , if WD dont  received 2*timeout, then WD RESET the MB.

while true; do
	echo "Pinging watchdog"
	$ping > $PORT
	sleep 5
done
